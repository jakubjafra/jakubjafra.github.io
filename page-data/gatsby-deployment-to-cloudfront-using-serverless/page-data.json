{"componentChunkName":"component---node-modules-gatsby-theme-blog-core-src-templates-post-query-js","path":"/gatsby-deployment-to-cloudfront-using-serverless/","result":{"data":{"site":{"siteMetadata":{"title":"Devlog","social":[{"name":"email","url":"mailto:jakub.jafra@gmail.com"},{"name":"linkedin","url":"https://www.linkedin.com/in/jakub-jafra-355150a4/"},{"name":"github","url":"https://github.com/jakubjafra"}]}},"blogPost":{"__typename":"MdxBlogPost","id":"56b1d61b-c6f9-5f1f-9c1a-8b132c220b3c","excerpt":"Deploying a static Gatsby site to CloudFront can be challenging. There is an excellent\n gatsby-plugin-s3  (which I'll be using) with a…","body":"function _extends() { _extends = Object.assign || function (target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i]; for (var key in source) { if (Object.prototype.hasOwnProperty.call(source, key)) { target[key] = source[key]; } } } return target; }; return _extends.apply(this, arguments); }\n\nfunction _objectWithoutProperties(source, excluded) { if (source == null) return {}; var target = _objectWithoutPropertiesLoose(source, excluded); var key, i; if (Object.getOwnPropertySymbols) { var sourceSymbolKeys = Object.getOwnPropertySymbols(source); for (i = 0; i < sourceSymbolKeys.length; i++) { key = sourceSymbolKeys[i]; if (excluded.indexOf(key) >= 0) continue; if (!Object.prototype.propertyIsEnumerable.call(source, key)) continue; target[key] = source[key]; } } return target; }\n\nfunction _objectWithoutPropertiesLoose(source, excluded) { if (source == null) return {}; var target = {}; var sourceKeys = Object.keys(source); var key, i; for (i = 0; i < sourceKeys.length; i++) { key = sourceKeys[i]; if (excluded.indexOf(key) >= 0) continue; target[key] = source[key]; } return target; }\n\n/* @jsxRuntime classic */\n\n/* @jsx mdx */\nvar _frontmatter = {\n  \"title\": \"Deploying a Gatsby site to CloudFront using Serverless\",\n  \"date\": \"2021-02-28T00:00:00.000Z\",\n  \"tags\": [\"gatsby\", \"serverless\", \"aws\", \"cloudformation\"]\n};\nvar layoutProps = {\n  _frontmatter: _frontmatter\n};\nvar MDXLayout = \"wrapper\";\nreturn function MDXContent(_ref) {\n  var components = _ref.components,\n      props = _objectWithoutProperties(_ref, [\"components\"]);\n\n  return mdx(MDXLayout, _extends({}, layoutProps, props, {\n    components: components,\n    mdxType: \"MDXLayout\"\n  }), mdx(\"p\", null, \"Deploying a static Gatsby site to CloudFront can be challenging. There is an excellent\\n\", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"gatsby-plugin-s3\"), \" (which I\\u2019ll be using) with a terrible documentation piece around deploying to\\nCloudFront. And when I tried to add \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"serverless\"), \"\\u2019s deployments to the mix, it took me some time to\\nget it all working.\"), mdx(\"p\", null, \"I wanted to deploy my static site to AWS using Serverless framework because:\"), mdx(\"ul\", null, mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"it enables reliable infrastructure management (no dangling resources, easy cleanup, nearly no\\nmanual work)\"), mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"to integrate with API layer on the same domain (a Lambda service, using API Gateway)\", mdx(\"ul\", {\n    parentName: \"li\"\n  }, mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"with the ability to run the API layer using \", mdx(\"inlineCode\", {\n    parentName: \"li\"\n  }, \"serverless-offline\"), \" plugin on the localhost\"))), mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"have the hosting on the same provider as the rest of the infrastructure\"), mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"keep initial costs to the minimum\")), mdx(\"h1\", {\n    \"id\": \"prerequisites\"\n  }, \"Prerequisites\"), mdx(\"p\", null, \"Install these required dependencies to your Gatsby project:\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-bash\"\n  }, \"npm install gatsby-plugin-s3 gatsby-plugin-canonical-urls\\nnpm install --save-dev serverless serverless-s3-sync serverless-cloudfront-invalidate\\n\")), mdx(\"p\", null, mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"gatsby-plugin-canonical-urls\"), \" is a plugin to fix SEO after we make our S3 site publicly available,\\nas described in the \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"gatsby-plugin-s3\"), \"\\u2019s documentation\\n\", mdx(\"a\", {\n    parentName: \"p\",\n    \"href\": \"https://gatsby-plugin-s3.jari.io/recipes/with-cloudfront\"\n  }, \"here\"), \".\"), mdx(\"p\", null, mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"serverless-cloudfront-invalidate\"), \" is a plugin required for optimal CloudFront cache configuration,\\nagain as described in the \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"gatsby-plugin-s3\"), \"\\u2019s documentation\\n\", mdx(\"a\", {\n    parentName: \"p\",\n    \"href\": \"https://gatsby-plugin-s3.jari.io/recipes/with-cloudfront\"\n  }, \"here\"), \".\"), mdx(\"p\", null, \"Then, in your \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"gatsby-config.js\"), \" add this configuration:\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-js\"\n  }, \"// somewhere on the top of the file:\\nconst siteAddress = new URL('https://your-site.address');\\n\\n// to the plugins:\\nmodule.exports = {\\n  // your stuff...\\n  plugins: [\\n    // your plugins...\\n    {\\n      resolve: `gatsby-plugin-canonical-urls`,\\n      options: {\\n        siteUrl: siteAddress.href.slice(0, -1),\\n      },\\n    },\\n    {\\n      resolve: `gatsby-plugin-s3`,\\n      options: {\\n        bucketName: 'my-example-bucket',\\n        protocol: siteAddress.protocol.slice(0, -1),\\n        hostname: siteAddress.hostname,\\n      },\\n    },\\n  ],\\n};\\n\")), mdx(\"p\", null, \"You can also modify your \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"package.json\"), \" and add scripts for deployment:\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-json\"\n  }, \"{\\n  \\\"scripts\\\": {\\n    \\\"deploy-dev\\\": \\\"serverless deploy --force --stage=dev\\\",\\n    \\\"deploy-prod\\\": \\\"serverless deploy --force --stage=prod\\\"\\n  }\\n}\\n\")), mdx(\"h1\", {\n    \"id\": \"serverlessyml---without-api-gateway-but-with-stages\"\n  }, \"serverless.yml - without API Gateway, but with stages\"), mdx(\"p\", null, \"A \\u201Cbasic\\u201D file that I ended up with can is here (put it in your\\u2019s root folder):\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-yml\"\n  }, \"service: your-service-name\\nunresolvedVariablesNotificationMode: error # future proofing\\nvariablesResolutionMode: 20210219 # future proofing\\n\\nplugins:\\n  - serverless-s3-sync\\n  - serverless-cloudfront-invalidate\\n\\nprovider:\\n  name: aws\\n  region: eu-west-1 # could be different!\\n  runtime: nodejs12.x\\n  stage: ${opt:stage}\\n  endpointType: REGIONAL\\n  memorySize: 128\\n  lambdaHashingVersion: 20201221 # future proofing\\n  apiGateway:\\n    shouldStartNameWithService: true # future proofing\\n\\n# here most of your configuration will happen:\\n# I'm also using a trick to enable stages, see [C] below\\ncustom:\\n  gatsbyPublicDir: ./public # a path to Gatsby's public folder\\n  gatsbyCacheDir: ./.cache # a path to Gatsby's .cache folder\\n  bucketNames: # bucket names for deployment, those need to be also your domain names\\n    localhost: dev.your-site.address # doesn't really matter\\n    dev: dev.your-site.address # in order to use subdomain, you have to have wildcard certificate\\n    prod: your-site.address # your production site address\\n  loggingBucketName: fitsearch-frontend-logs.s3.amazonaws.com # CloudFront's log's bucket name\\n  frontendBucketName: ${self:custom.bucketNames.${self:provider.stage}} # the bucket name is based on the stage\\n  domainCertificateArn: arn:aws:acm:us-east-1:298671596134:certificate/3a9c15fe-47ed-4475-a16d-38f9fb88b892 # your SSL cerificate for that domain, see [A] below\\n  # fix for local development:\\n  s3SyncParamsFileLocation:\\n    localhost: ./dummyS3Params.json\\n    dev: ${self:custom.gatsbyCacheDir}/s3.params.json\\n    prod: ${self:custom.gatsbyCacheDir}/s3.params.json\\n  s3RoutingRulesFileLocation:\\n    localhost: ./dummyS3Params.json\\n    dev: ${self:custom.gatsbyCacheDir}/s3.sls.routingRules.json\\n    prod: ${self:custom.gatsbyCacheDir}/s3.sls.routingRules.json\\n  # plugin's custom config:\\n  s3Sync:\\n    - bucketName: ${self:custom.frontendBucketName}\\n      localDir: ${self:custom.gatsbyPublicDir}\\n      deleteRemoved: true\\n      acl: public-read\\n      defaultContentType: text/html\\n      params: ${file(${self:custom.s3SyncParamsFileLocation.${self:provider.stage}})}\\n  cloudfrontInvalidate:\\n    - distributionIdKey: 'FrontendCloudFrontDistributionId'\\n      autoInvalidate: true\\n      items:\\n        - '/*'\\n\\nresources:\\n  Resources:\\n    FrontendBucket: # this will create our bucket (gatsby-s3-plugin needs exsisiting bucket manually created)\\n      Type: AWS::S3::Bucket\\n      Properties:\\n        BucketName: ${self:custom.frontendBucketName}\\n        AccessControl: PublicRead\\n        WebsiteConfiguration:\\n          IndexDocument: index.html\\n          ErrorDocument: 404.html\\n          RoutingRules: ${file(${self:custom.s3RoutingRulesFileLocation.${self:provider.stage}})}\\n        CorsConfiguration:\\n          CorsRules:\\n            - AllowedMethods:\\n                - GET\\n              AllowedOrigins:\\n                - '*'\\n              AllowedHeaders:\\n                - 'Authorization'\\n                - 'Content-Length'\\n              MaxAge: 3000\\n    FrontendBucketPolicy: # the bucket also need a public access policy, since we'll use S3 bucket hosting\\n      Type: AWS::S3::BucketPolicy\\n      Properties:\\n        Bucket:\\n          Ref: FrontendBucket\\n        PolicyDocument:\\n          Statement:\\n            - Sid: 1\\n              Effect: Allow\\n              Principal: { AWS: '*' }\\n              Action:\\n                - s3:GetObject\\n              Resource: arn:aws:s3:::${self:custom.frontendBucketName}/*\\n    FrontendCloudFrontDistribution:\\n      Type: AWS::CloudFront::Distribution\\n      Properties:\\n        DistributionConfig:\\n          Origins:\\n            - DomainName: !Select [1, !Split ['//', !GetAtt FrontendBucket.WebsiteURL]]\\n              Id: FrontendCloudFrontS3Origin\\n              CustomOriginConfig:\\n                HTTPPort: 80\\n                HTTPSPort: 443\\n                OriginProtocolPolicy: http-only\\n          Enabled: 'true'\\n          PriceClass: 'PriceClass_100' # cheapest price class, for USA & EU regions\\n          HttpVersion: 'http2'\\n          Aliases:\\n            - ${self:custom.frontendBucketName} # the CloudFront is ready to be plugged in into Route 53, but it's not automatically added, see [B] below\\n          DefaultRootObject: index.html\\n          DefaultCacheBehavior:\\n            TargetOriginId: FrontendCloudFrontS3Origin\\n            # Caching Optimized (AWS managed cache policy)\\n            CachePolicyId: 658327ea-f89d-4fab-a63d-7e88639e58f6\\n            AllowedMethods:\\n              - GET\\n              - HEAD\\n            ForwardedValues:\\n              QueryString: 'false'\\n              Cookies:\\n                Forward: none\\n            ViewerProtocolPolicy: redirect-to-https\\n            Compress: 'true'\\n          ViewerCertificate:\\n            AcmCertificateArn: ${self:custom.domainCertificateArn}\\n            SslSupportMethod: sni-only\\n          Logging:\\n            IncludeCookies: 'false'\\n            Bucket: ${self:custom.loggingBucketName}\\n            Prefix: ${self:custom.frontendBucketName}\\n  Outputs:\\n    FrontendCloudFrontDistributionId:\\n      Value:\\n        Ref: FrontendCloudFrontDistribution\\n\")), mdx(\"p\", null, \"For \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"serverless-offline\"), \"\\u2019s compatibility, it\\u2019s also needed to create a file called\\n\", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"dummyS3Params.json\"), \" next to the \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"serverless.yml\"), \". Fill it with just an empty object inside:\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-json\"\n  }, \"{}\\n\")), mdx(\"p\", null, \"It acts as a placeholder for the plugins that need \", mdx(\"em\", {\n    parentName: \"p\"\n  }, \"something\"), \" even they are not used when running\\non localhost. If you indeed add \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"serverless-offline\"), \" plugin, rememeber to use \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"localhost\"), \" stage.\"), mdx(\"p\", null, \"To deploy, just execute the script you\\u2019ve added recently:\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\"\n  }, \"npm run deploy-dev\\n\")), mdx(\"h4\", {\n    \"id\": \"a-domain-certificate\"\n  }, \"A) Domain certificate\"), mdx(\"p\", null, \"In order for this to work you need to manually create a domain certificate and put its ARN to the\\ncustom config above. It\\u2019s very easy to do via AWS console \\u201CCertificate Manager\\u201D. If you want to use\\na subdomain it\\u2019s important to add the wildcard (\", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"*.example.com\"), \") to the certificate\\u2019s domain - you\\ncannot do that later!\"), mdx(\"div\", {\n    \"style\": {\n      \"width\": \"100%\",\n      \"margin\": \"auto\"\n    }\n  }, \"\\n  \", mdx(\"span\", {\n    parentName: \"div\",\n    \"className\": \"gatsby-resp-image-wrapper\",\n    \"style\": {\n      \"position\": \"relative\",\n      \"display\": \"block\",\n      \"marginLeft\": \"auto\",\n      \"marginRight\": \"auto\",\n      \"maxWidth\": \"1380px\"\n    }\n  }, \"\\n      \", mdx(\"span\", {\n    parentName: \"span\",\n    \"className\": \"gatsby-resp-image-background-image\",\n    \"style\": {\n      \"paddingBottom\": \"31.884057971014496%\",\n      \"position\": \"relative\",\n      \"bottom\": \"0\",\n      \"left\": \"0\",\n      \"backgroundImage\": \"url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAYAAADDl76dAAAACXBIWXMAABYlAAAWJQFJUiTwAAABKUlEQVQY012QyUvDQBSH8//felEodlXaKIjgwavgrW70qCLGpEu20mSyNLFZPidpQsUf883vvXlv3sAo/fGU7mBCb3xZe3c4oXPap3PSo6oNz1UGDaMLlWFDfzxpXOVspMr7BxSKjDiKoCxotfvJCOKETMbFHxK57fIDbVx5S5Ur+/2eNE1JkqT2cJfyqnnMPlxePiWaz9OXz1wXmNsQ2wtx/Lghqt0Vx1wJggDP86gG53kmB/5w9fDO9P6N29k3N88O148Wd3OXIIzIZN9BpVxlEx5d4Z/yPEd4GzaOiWOt2W5szKWOvV7i2DaLxQJN01itVpimiWEYWJYlz5d1rpRyakuloiiI4hjfF/hCEMr/1XUDx3XrL3GlV0NEXQtZuxax7LflY1XtF4r6tv7Dh5ebAAAAAElFTkSuQmCC')\",\n      \"backgroundSize\": \"cover\",\n      \"display\": \"block\"\n    }\n  }), \"\\n  \", mdx(\"img\", {\n    parentName: \"span\",\n    \"className\": \"gatsby-resp-image-image\",\n    \"alt\": \"certificateManager\",\n    \"title\": \"certificateManager\",\n    \"src\": \"/static/87e67bb0663bfde8871119b92837e1c8/b1001/certificateManager.png\",\n    \"srcSet\": [\"/static/87e67bb0663bfde8871119b92837e1c8/e4d6b/certificateManager.png 345w\", \"/static/87e67bb0663bfde8871119b92837e1c8/1e043/certificateManager.png 690w\", \"/static/87e67bb0663bfde8871119b92837e1c8/b1001/certificateManager.png 1380w\", \"/static/87e67bb0663bfde8871119b92837e1c8/a6d66/certificateManager.png 2070w\", \"/static/87e67bb0663bfde8871119b92837e1c8/49832/certificateManager.png 2374w\"],\n    \"sizes\": \"(max-width: 1380px) 100vw, 1380px\",\n    \"style\": {\n      \"width\": \"100%\",\n      \"height\": \"100%\",\n      \"margin\": \"0\",\n      \"verticalAlign\": \"middle\",\n      \"position\": \"absolute\",\n      \"top\": \"0\",\n      \"left\": \"0\"\n    },\n    \"loading\": \"lazy\"\n  }), \"\\n    \")), mdx(\"h4\", {\n    \"id\": \"b-adding-the-cloudfront-to-route-53\"\n  }, \"B) Adding the CloudFront to Route 53\"), mdx(\"p\", null, \"If you are hosting your domain on Route 53, it\\u2019s easy to add a deployed CloudFront via AWS console\\n(remember to use the \\u201Calias\\u201D option):\"), mdx(\"div\", {\n    \"style\": {\n      \"width\": \"100%\",\n      \"margin\": \"auto\"\n    }\n  }, \"\\n  \", mdx(\"span\", {\n    parentName: \"div\",\n    \"className\": \"gatsby-resp-image-wrapper\",\n    \"style\": {\n      \"position\": \"relative\",\n      \"display\": \"block\",\n      \"marginLeft\": \"auto\",\n      \"marginRight\": \"auto\",\n      \"maxWidth\": \"1380px\"\n    }\n  }, \"\\n      \", mdx(\"span\", {\n    parentName: \"span\",\n    \"className\": \"gatsby-resp-image-background-image\",\n    \"style\": {\n      \"paddingBottom\": \"39.130434782608695%\",\n      \"position\": \"relative\",\n      \"bottom\": \"0\",\n      \"left\": \"0\",\n      \"backgroundImage\": \"url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAYAAAD5nd/tAAAACXBIWXMAABYlAAAWJQFJUiTwAAABSklEQVQoz21RPVPDMAz1v2Ziojuw05/QKysz3SkbsPVKm6RJaid2PuwkfkhOQ3u96u6dbcmS3pNEnCTYbn+x2+2Q5keYukXbjmiaBk17fk+oyZ9Ig4igSo00ywg5irKEMKYKiX3XobUW/TBgOGE0D3/hG+HhesaAjvK4qdYadV1D7KMIX98/xE6GZP7AxolSSihdwZKP/Y7gvScCLY55DlloWDf+T6TG/pBBvK9WeHx6xmL5CqkKZESdZTnncKSCLEUqFcBvLqa1obtCSeqSNAtSWyqsqwrC42zcfTqn+y1jiS/zOR5mM3ys16FRmC1LVsTqcEihaRlcJMzIj9I5xuAZX1scx9hsNiH2T4QgmHpEQU30Waa1LjDgTVbUkU9Ly+pOc5xwqarre3SUy36hjQmJvCWeRUnnLXDsGqogMjnN9vMNcnEHubzHH2rAZZv72R5tAAAAAElFTkSuQmCC')\",\n      \"backgroundSize\": \"cover\",\n      \"display\": \"block\"\n    }\n  }), \"\\n  \", mdx(\"img\", {\n    parentName: \"span\",\n    \"className\": \"gatsby-resp-image-image\",\n    \"alt\": \"route53\",\n    \"title\": \"route53\",\n    \"src\": \"/static/1a4f07e2c37ec132bb666e8e05869e94/b1001/route53.png\",\n    \"srcSet\": [\"/static/1a4f07e2c37ec132bb666e8e05869e94/e4d6b/route53.png 345w\", \"/static/1a4f07e2c37ec132bb666e8e05869e94/1e043/route53.png 690w\", \"/static/1a4f07e2c37ec132bb666e8e05869e94/b1001/route53.png 1380w\", \"/static/1a4f07e2c37ec132bb666e8e05869e94/a6d66/route53.png 2070w\", \"/static/1a4f07e2c37ec132bb666e8e05869e94/39f45/route53.png 2184w\"],\n    \"sizes\": \"(max-width: 1380px) 100vw, 1380px\",\n    \"style\": {\n      \"width\": \"100%\",\n      \"height\": \"100%\",\n      \"margin\": \"0\",\n      \"verticalAlign\": \"middle\",\n      \"position\": \"absolute\",\n      \"top\": \"0\",\n      \"left\": \"0\"\n    },\n    \"loading\": \"lazy\"\n  }), \"\\n    \")), mdx(\"h4\", {\n    \"id\": \"c-trick-for-easy-stages-configuration\"\n  }, \"C) Trick for easy stages configuration\"), mdx(\"p\", null, \"The script above is using a \\u201Ctrick\\u201D for conditional resource name resolution:\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-yml\"\n  }, \"custom:\\n  enabled:\\n    dev: false\\n    prod: true\\nenabled: ${self:custom.enabled.${self:provider.stage}}\\n\")), mdx(\"p\", null, \"I found it \", mdx(\"a\", {\n    parentName: \"p\",\n    \"href\": \"https://forum.serverless.com/t/conditional-serverless-yml-based-on-stage/1763\"\n  }, \"here\"), \".\"), mdx(\"h1\", {\n    \"id\": \"serverlessyml---with-api-gateway-and-stages\"\n  }, \"serverless.yml - with API Gateway and stages\"), mdx(\"p\", null, \"We can modifiy the above example in order to support API Gateway request passing through CloudFront\\non a given URL pattern. I\\u2019ll try to distil down the required changes to the above file:\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-yml\"\n  }, \"# ...\\n\\ncustom:\\n  apiGatewayPathPattern: /api # so our API layer will be available under your-site.address/api\\n  # ...\\n\\n# ...\\n\\nfunctions:\\n  yourFunction:\\n    handler: src/yourFunction.handler\\n    events:\\n      - http: GET ${self:custom.apiGatewayPathPattern} # it's important to start with the apiGatewayPathPattern \\n      - http: GET ${self:custom.apiGatewayPathPattern}/{proxy+} # and then you can do all sorts of things\\n\\nresources:\\n  Resources:\\n    # ...\\n    FrontendCloudFrontDistribution:\\n      Type: AWS::CloudFront::Distribution\\n      Properties:\\n        DistributionConfig:\\n          Origins:\\n            - DomainName: # first one is the default origin from the above\\n              # ...\\n             - DomainName: # we're constructing API Gateway URL scheme based on the data provided\\n                !Join [\\n                  '',\\n                  [\\n                    !Ref ApiGatewayRestApi,\\n                    '.execute-api.',\\n                    '${self:provider.region}',\\n                    '.amazonaws.com',\\n                  ],\\n                ]\\n              OriginPath: '/${self:provider.stage}'\\n              Id: FrontendCloudFrontApiGatewayOrigin\\n              CustomOriginConfig:\\n                HTTPPort: 80\\n                HTTPSPort: 443\\n                OriginProtocolPolicy: https-only # we want to have our requests encrypted\\n                OriginSSLProtocols: # API Gateway does not support any other configuration here\\n                  - TLSv1\\n                  - TLSv1.1\\n                  - TLSv1.2\\n          # ...\\n          CacheBehaviors:\\n            - TargetOriginId: FrontendCloudFrontApiGatewayOrigin\\n              PathPattern: ${self:custom.apiGatewayPathPattern}*\\n              # Caching Disabled (AWS managed cache policy)\\n              CachePolicyId: 4135ea2d-6df8-44a3-9df3-4b5a84be39ad\\n              AllowedMethods:\\n                - GET\\n                - HEAD\\n                - OPTIONS\\n                - PUT\\n                - POST\\n                - PATCH\\n                - DELETE\\n              # Custom origin request policy is optional, see below [D]\\n              # OriginRequestPolicyId: 2ab11ffc-1ccc-4410-94ac-520235f52eeb\\n              ViewerProtocolPolicy: redirect-to-https\\n              Compress: 'true'\\n          DefaultCacheBehavior: # stays the same\\n          # ...\\n\")), mdx(\"h4\", {\n    \"id\": \"d-custom-origin-request-policy\"\n  }, \"D) Custom origin request policy\"), mdx(\"p\", null, \"If you want to forward custom headers, cookies or query strings (and you probalby do), you need to\\ncreate an origin request policy. I didn\\u2019t automate that step, since you only need to do it once.\\nIt\\u2019s fairly tricky to do, but firstly go to \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"CloudFront > Policies > Origin request policy\"), \" tab and\\nclick \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"Create origin request policy\"), \":\"), mdx(\"div\", {\n    \"style\": {\n      \"width\": \"100%\",\n      \"margin\": \"auto\"\n    }\n  }, \"\\n  \", mdx(\"span\", {\n    parentName: \"div\",\n    \"className\": \"gatsby-resp-image-wrapper\",\n    \"style\": {\n      \"position\": \"relative\",\n      \"display\": \"block\",\n      \"marginLeft\": \"auto\",\n      \"marginRight\": \"auto\",\n      \"maxWidth\": \"1380px\"\n    }\n  }, \"\\n      \", mdx(\"span\", {\n    parentName: \"span\",\n    \"className\": \"gatsby-resp-image-background-image\",\n    \"style\": {\n      \"paddingBottom\": \"15.36231884057971%\",\n      \"position\": \"relative\",\n      \"bottom\": \"0\",\n      \"left\": \"0\",\n      \"backgroundImage\": \"url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAADCAYAAACTWi8uAAAACXBIWXMAABYlAAAWJQFJUiTwAAAAeElEQVQI16XOOw7CMBCEYd//HDQ0nIGCAtFzhAibKC/b4DVe58ehT8VKn6YazZoohZQ/VC2wbpR/zmRJLN4Tl5HQd0iYqHVt6i5V/SnN/C5Ny5cSRTEhBJxzWGt5DhNJMtJGRGTX1gntiXH2nG6W4/XB4dJxvvd8AQdN6NlWvrI/AAAAAElFTkSuQmCC')\",\n      \"backgroundSize\": \"cover\",\n      \"display\": \"block\"\n    }\n  }), \"\\n  \", mdx(\"img\", {\n    parentName: \"span\",\n    \"className\": \"gatsby-resp-image-image\",\n    \"alt\": \"policy1\",\n    \"title\": \"policy1\",\n    \"src\": \"/static/e204d57339d39d8889233d0b1fdc4097/b1001/policy1.png\",\n    \"srcSet\": [\"/static/e204d57339d39d8889233d0b1fdc4097/e4d6b/policy1.png 345w\", \"/static/e204d57339d39d8889233d0b1fdc4097/1e043/policy1.png 690w\", \"/static/e204d57339d39d8889233d0b1fdc4097/b1001/policy1.png 1380w\", \"/static/e204d57339d39d8889233d0b1fdc4097/a6d66/policy1.png 2070w\", \"/static/e204d57339d39d8889233d0b1fdc4097/e872c/policy1.png 2606w\"],\n    \"sizes\": \"(max-width: 1380px) 100vw, 1380px\",\n    \"style\": {\n      \"width\": \"100%\",\n      \"height\": \"100%\",\n      \"margin\": \"0\",\n      \"verticalAlign\": \"middle\",\n      \"position\": \"absolute\",\n      \"top\": \"0\",\n      \"left\": \"0\"\n    },\n    \"loading\": \"lazy\"\n  }), \"\\n    \")), mdx(\"p\", null, \"And then fill the required resources you need to use:\"), mdx(\"div\", {\n    \"style\": {\n      \"width\": \"100%\",\n      \"margin\": \"auto\"\n    }\n  }, \"\\n  \", mdx(\"span\", {\n    parentName: \"div\",\n    \"className\": \"gatsby-resp-image-wrapper\",\n    \"style\": {\n      \"position\": \"relative\",\n      \"display\": \"block\",\n      \"marginLeft\": \"auto\",\n      \"marginRight\": \"auto\",\n      \"maxWidth\": \"1380px\"\n    }\n  }, \"\\n      \", mdx(\"span\", {\n    parentName: \"span\",\n    \"className\": \"gatsby-resp-image-background-image\",\n    \"style\": {\n      \"paddingBottom\": \"83.76811594202897%\",\n      \"position\": \"relative\",\n      \"bottom\": \"0\",\n      \"left\": \"0\",\n      \"backgroundImage\": \"url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAARCAYAAADdRIy+AAAACXBIWXMAABYlAAAWJQFJUiTwAAABT0lEQVQ4y6VUUW6EIBT0/O1XL9Ckl+gm/Wx6k9YEKSoqKIo65ZHFda1u2ZRkEl94mTfMgAmXLRptUDYGujVQTYPGQSmFaZpAa57naCTimyPL2BkZGGMeQoiF7J6VaN36j4km3KlmV2Fd1xjH0Rd0xPXmto7ZS8qyhNbaF0RMjbHYsyNp2xbDMPgGIozFmvBK4Z6xsX7thlIUBfJcOOQeNB3/CMd7KMrK+0iw1i6mh2Md+bdLSAq183Ht4a0AwoC+749DqevKv46qqnxAW1XGGEgpkaYpqN/f21vXhmUcnHPffHTnaFDXdYvH6wCvQ3GEslYwrpmUhEt+lGioQ9+WNKGp5MfgwqBA1oS3QgnW/DqylCXyQkJpIjaLyr9eyfboi0JSdUlvPlS0hXUKjZ2h+ws6e34psb+o0NXbCcqMePlgeHj9xNNbisfTF57fGX4AeZc5+DPKTxEAAAAASUVORK5CYII=')\",\n      \"backgroundSize\": \"cover\",\n      \"display\": \"block\"\n    }\n  }), \"\\n  \", mdx(\"img\", {\n    parentName: \"span\",\n    \"className\": \"gatsby-resp-image-image\",\n    \"alt\": \"policy2\",\n    \"title\": \"policy2\",\n    \"src\": \"/static/dab52a0463380e0fb0e55874219ba651/b1001/policy2.png\",\n    \"srcSet\": [\"/static/dab52a0463380e0fb0e55874219ba651/e4d6b/policy2.png 345w\", \"/static/dab52a0463380e0fb0e55874219ba651/1e043/policy2.png 690w\", \"/static/dab52a0463380e0fb0e55874219ba651/b1001/policy2.png 1380w\", \"/static/dab52a0463380e0fb0e55874219ba651/6297e/policy2.png 2044w\"],\n    \"sizes\": \"(max-width: 1380px) 100vw, 1380px\",\n    \"style\": {\n      \"width\": \"100%\",\n      \"height\": \"100%\",\n      \"margin\": \"0\",\n      \"verticalAlign\": \"middle\",\n      \"position\": \"absolute\",\n      \"top\": \"0\",\n      \"left\": \"0\"\n    },\n    \"loading\": \"lazy\"\n  }), \"\\n    \")), mdx(\"p\", null, \"The \\u201CHeaders\\u201D part is a bit tricky, since - I think - you need to specify the headers you will be\\nusing directly. I had some problems with \\u201CAll viewer headers\\u201D and custom headers, but you might want\\nto try it.\"));\n}\n;\nMDXContent.isMDXComponent = true;","slug":"/gatsby-deployment-to-cloudfront-using-serverless/","title":"Deploying a Gatsby site to CloudFront using Serverless","tags":["gatsby","serverless","aws","cloudformation"],"date":"February 28, 2021","image":null,"imageAlt":null,"imageCaptionText":null,"imageCaptionLink":null,"socialImage":null},"previous":{"__typename":"MdxBlogPost","id":"fed733e3-160f-56fc-8259-610061f37fdc","excerpt":"In my latest project, I'm using monorepo structure using lerna. I'm sharing some common components\nbetween two different frontend projects…","slug":"/lerna-gatsby-components-reuse/","title":"Reusing custom Material UI components using Lerna and Gatsby","date":"February 15, 2021"},"next":null},"pageContext":{"id":"56b1d61b-c6f9-5f1f-9c1a-8b132c220b3c","previousId":"fed733e3-160f-56fc-8259-610061f37fdc","maxWidth":1380}},"staticQueryHashes":["2744905544","3090755652","3473179899","764694655","955223363"]}